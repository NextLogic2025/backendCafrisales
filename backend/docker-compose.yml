# =========================================
# 1. VARIABLES COMUNES
# =========================================
x-common-env: &common-env
  NODE_ENV: development
  PORT: 3000
  JWT_SECRET: ${JWT_SECRET}
  SERVICE_TOKEN: ${SERVICE_TOKEN}
  # URLs internas entre contenedores
  AUTH_SERVICE_URL: ${AUTH_URL}
  USUARIOS_SERVICE_URL: ${USUARIOS_URL}
  CATALOG_SERVICE_URL: ${CATALOG_URL}
  ZONE_SERVICE_URL: ${ZONAS_URL}
  ORDERS_SERVICE_URL: ${ORDERS_URL}
  FINANCE_SERVICE_URL: ${FINANCE_URL}
  CREDIT_SERVICE_URL: ${CREDIT_URL}
  ROUTE_SERVICE_URL: ${ROUTE_URL}
  DELIVERY_SERVICE_URL: ${DELIVERY_URL}
  NOTIFICATION_SERVICE_URL: ${NOTIFICATION_URL}

services:
  # =========================================
  # 2. INFRAESTRUCTURA
  # =========================================
  database:
    image: postgis/postgis:17-3.4-alpine
    container_name: gcp-sql-local
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - ./infra/local-init:/docker-entrypoint-initdb.d
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DB_USER} -d postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 60s
    networks:
      - app-network

  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin-local
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: ${DB_PASSWORD}
    ports:
      - "8080:80"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - app-network

  # =========================================
  # 3. MICROSERVICIOS
  # =========================================

  # --- AUTH SERVICE ---
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    restart: on-failure
    environment:
      <<: *common-env
      DATABASE_URL: postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/cafrilosa_auth
    ports:
      - "3001:3000"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -q -T 2 -O /dev/null http://127.0.0.1:3000/api/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s

  # --- USER SERVICE ---
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: user-service
    restart: on-failure
    environment:
      <<: *common-env
      DATABASE_URL: postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/cafrilosa_usuarios
    ports:
      - "3002:3000"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -q -T 2 -O /dev/null http://127.0.0.1:3000/api/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s

  # --- CATALOG SERVICE ---
  catalog-service:
    build:
      context: ./services/catalog-service
      dockerfile: Dockerfile
    container_name: catalog-service
    restart: on-failure
    environment:
      <<: *common-env
      DATABASE_URL: postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/cafrilosa_catalogo
    ports:
      - "3003:3000"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -q -T 2 -O /dev/null http://127.0.0.1:3000/api/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s

  # --- ZONE SERVICE ---
  zone-service:
    build:
      context: ./services/zone-service
      dockerfile: Dockerfile
    container_name: zone-service
    restart: on-failure
    environment:
      <<: *common-env
      # Nota: Requiere que la DB 'cafrilosa_zonas' tenga la extensión PostGIS activada
      DATABASE_URL: postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/cafrilosa_zonas
    ports:
      - "3004:3000"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      # Asumiendo que usarás Global Prefix 'api' como en los otros (salvo catalogo que usó v1)
      test: [ "CMD-SHELL", "wget -q -T 2 -O /dev/null http://127.0.0.1:3000/api/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s
  # --- ORDER SERVICE ---
  order-service:
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    container_name: order-service
    restart: on-failure
    environment:
      <<: *common-env
      DATABASE_URL: postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/cafrilosa_pedidos
    ports:
      - "3005:3000"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -q -T 2 -O /dev/null http://127.0.0.1:3000/api/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s
  # --- CREDIT SERVICE ---
  credit-service:
    build:
      context: ./services/credit-service
      dockerfile: Dockerfile
    container_name: credit-service
    restart: on-failure
    environment:
      <<: *common-env
      DATABASE_URL: postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/cafrilosa_creditos
    ports:
      - "3006:3000"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -q -T 2 -O /dev/null http://127.0.0.1:3000/api/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s
  # --- ROUTE SERVICE ---
  route-service:
    build:
      context: ./services/route-service
      dockerfile: Dockerfile
    container_name: route-service
    restart: on-failure
    environment:
      <<: *common-env
      DATABASE_URL: postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/cafrilosa_rutas
    ports:
      - "3007:3000"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -q -T 2 -O /dev/null http://127.0.0.1:3000/api/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s
  # --- DELIVERY SERVICE ---
  delivery-service:
    build:
      context: ./services/delivery-service
      dockerfile: Dockerfile
    container_name: delivery-service
    restart: on-failure
    environment:
      <<: *common-env
      DATABASE_URL: postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/cafrilosa_entregas
      UPLOAD_PATH: /app/uploads/evidence
    ports:
      - "3008:3000"
    volumes:
      - delivery-uploads:/app/uploads/evidence
    depends_on:
      database:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -q -T 2 -O /dev/null http://127.0.0.1:3000/api/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s
  # --- NOTIFICATION SERVICE ---
  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    container_name: notification-service
    restart: on-failure
    environment:
      <<: *common-env
      USER_SERVICE_URL: ${USUARIOS_URL}
      # Main notification database
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: cafrilosa_notificaciones
      DB_LOGGING: "false"
      # Order service database (for reading outbox)
      ORDER_DB_HOST: ${DB_HOST}
      ORDER_DB_PORT: ${DB_PORT}
      ORDER_DB_USER: ${DB_USER}
      ORDER_DB_PASSWORD: ${DB_PASSWORD}
      ORDER_DB_NAME: cafrilosa_pedidos
    ports:
      - "3009:3000"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -q -T 2 -O /dev/null http://127.0.0.1:3000/api/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  delivery-uploads:
